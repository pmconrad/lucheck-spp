<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>lucheck-spp README</title>
<style type="text/css">
* { font-family:Helvetica,Arial,Geneva; }
body { width:500px; }
</style>
</head>
<body>
<h1>lucheck-spp - A qmail-spp plugin for checking local users</h1>

<p>
All files in this package except those in the "cdb-0.75" subdirectory are
licensed under the GPL (v2.0, see below). Those in the "cdb-0.75" subdirectory
are public domain and were created by
<a href="http://cr.yp.to/djb.html">D. J. Bernstein</a>, see
the README in that subdirectory.
</p>

<blockquote>
<p>
    Copyright (C) 2004-2005,2011 Peter Conrad &lt;conrad@tivano.de>
</p><p>
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License (version 2) as
    published by the Free Software Foundation.
</p><p>
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    <a href="http://www.gnu.org/licenses/old-licenses/gpl-2.0.html#SEC1">GNU
    General Public License</a> for more details.
</p><p>
    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
</p>
</blockquote>
<p>
qmail-spp (<a href="http://qmail-spp.sf.net/">http://qmail-spp.sf.net/</a>) is
a patch for D. J. Bernstein's "<a href="http://qmail.org">qmail</a>" MTA
package. The patch enables "plugin" programs to be run at various stages
during an SMTP protocol exchange.
</p><p>
This package implements a qmail-spp-style plugin that performs certain checks
on the <em>user</em> part of envelope recipient addresses. In particular, if the
<em>domain</em> part of the envelope recipient indicates that the mail should be
delivered locally, it checks if <em>user</em> exists locally and if not rejects
the mail.
</p>

<h2>How it works</h2>

<p>
First, the plugin checks if the recipient address <em>user</em>@<em>domain</em>
should be checked at all by looking at the <code>RELAYCLIENT</code> environment
variable and comparing the <em>domain</em> part of the address to the domains
listed in <code>control/locals</code>. If <code>RELAYCLIENT</code> is set or
the domain is not listed in <code>control/locals</code>, it exits immediately.
</p><p>
If <code>control/virtualdomains</code> exists and <em>domain</em> is listed in
it, the plugin exits as well (assuming the local user for handling the virtual
domain is set up properly).
</p><p>
If the environment variable <code>LUCHECK_FFDB</code> is set, it uses its
contents as the pathname of a
<a href="http://cr.yp.to/fastforward.html">fastforward</a> style database. If
the database contains <em>user</em>, it accepts the address and exit.
</p><p>
It repeats the following steps:
</p>
<ol>
<li>If <em>user</em> is a local system user, it accepts the address and exits.
    </li>
<li>If <code>$LUCHECK_ALIASDIR/.qmail-<em>user</em></code> exists, it accepts
    the address and exits.</li>
<li>If <em>user</em> contains a dash ('-'), it strips the rightmost '-' and
    everything after it and repeats steps 1-3 with the new <em>user</em>.</li>
</ol>
<p>
If the address has not yet been accepted at this point, it is rejected with an
error message.
</p><p>
If the environment variable <code>LUCHECK_DEBUG</code> is set (to any value)
some debugging output will be sent to wherever your qmail-smtpd logs are
written.  Also, if the recipient is rejected, it will be rejected with a
temporary (4<i>xy</i>) SMTP response code instead of a permanent (5<i>xy</i>)
code.
</p><p>
If the environment variable <code>LUCHECK_VERBOSE</code> is set (to any value),
rejected addresses will be logged.
</p>

<h2>Status</h2>
<p>
The current implementation (with only minor modifications) has been in use on a productive system for several
years now and can be considered stable.
</p>

<h2>Downloading</h2>
<p>
This package should be available at 
<a href="http://www.unix-ag.uni-kl.de/~conrad/lucheck/">http://www.unix-ag.uni-kl.de/~conrad/lucheck/</a>
</p><p>
The sources are managed using the
<a href="http://www.gnu.org/software/gnu-arch/">GNU Arch</a> revision control
system. You can check out a copy using
</p>
<pre>
tla register-archive conrad@tivano.de--2004 \
        http://www.unix-ag.uni-kl.de/~conrad/Archives/conrad@tivano.de--2004
tla grab http://www.unix-ag.uni-kl.de/~conrad/lucheck/releases--1.0
</pre>

<h2>Building</h2>
<p>
Simply unpack the sources and type <code>make</code> in the top-level directory
of the distribution. This will create a subdirectory <code>,,build</code>, in
which the build will take place.
</p><p>
<b>Hint:</b> apparently you need <a
href="http://savannah.gnu.org/projects/make">GNU make</a>, which may be
installed under a different name on your platform. Or not at all.
</p><p>
The resulting executable will reside in <code>,,build/src/lucheck-spp</code>.
</p>

<h2>Installing</h2>
<p>
A "make install" target is <b>not</b> provided, because the installation process
requires some manual intervention as well as some decisions you'll have to
make yourself. Basically, you'll have to perform the steps enumerated below.
For RPM-based systems, a .spec file is provided (assuming a qmail installation
under /var/qmail). The RPM-based installation requires some manual work as
well.
</p>
<ol>
<li>As has been said above, this program is a <b>plugin</b> for a Qmail
    installation that was built with the qmail-spp patch. So, as the first
    step, you'll have to build and install Qmail with that patch.
<br>
    In the following, we'll assume that the patched Qmail is installed in
    <code>/var/qmail</code> (the default location).
</li>

<li>If you don't have a directory where your plugins reside, create it. It must
    be situated somewhere within the Qmail installation dir.
<br>
    In the following, we'll assume that the plugin dir is
    <code>/var/qmail/plugins</code>.
</li>

<li>After building this plugin with <code>make</code>, copy the resulting
    executable to the plugin directory <code>/var/qmail/plugins</code>.
</li>

<li>Modify whatever process you use for running qmail-smtpd to set the
    environment variable <code>LUCHECK_ALIASDIR</code> and optionally
    <code>LUCHECK_FFDB</code>, <code>LUCHECK_DEBUG</code> or
    <code>LUCHECK_VERBOSE</code> to appropriate values.
<br>
    For example:
<pre>
     LUCHECK_ALIASDIR=/var/qmail/alias
     LUCHECK_VERBOSE=yes
     export LUCHECK_ALIASDIR LUCHECK_VERBOSE
     tcpserver -R -v -x /etc/tcprules.smtpd.cdb -c 20 0 smtp qmail-smtpd 2&gt;&amp;1
</pre>
    Don't forget to restart the service if required!
</li>

<li>Enable the plugin by adding the path (relative to the qmail installation
    dir) to the <code>[rcpt]</code> section of the qmail-spp configuration file
    <code>/var/qmail/control/smtpplugins</code>.
    Minimal example:
<pre>
[auth]

[helo]

[mail]

[rcpt]
plugins/lucheck-spp
</pre>
</li>

<li>Keep an eye on your log files.
</li>
</ol>

</body></html>
<!--
arch-tag: 3ee3cffa-bb93-4bd3-8498-ea23be34b745
-->
