<html>
<head>
</head>
<body>
<h1>lucheck-spp - A qmail-spp plugin for checking local users</h1>

<p>
All files in this package except those in the "cdb-0.75" subdirectory are
licensed under the GPL (v2.0, see below). Those in the "cdb-0.75" subdirectory
are copyright by D. J. Bernstein, see the README in that subdirectory.
</p>

<blockquote>
<p>
    Copyright (C) 2004 Peter Conrad &lt;conrad@tivano.de>
</p><p>
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License (version 2) as
    published by the Free Software Foundation.
</p><p>
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    <a href="http://www.gnu.org/licenses/gpl.html#SEC1">GNU General Public License</a> for more details.
</p><p>
    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
</p>
</blockquote>
<p>
qmail-spp (<a href="http://qmail-spp.sf.net/">http://qmail-spp.sf.net/</a>) is a patch for D. J. Bernstein's 
"<a href="http://qmail.org">qmail</a>" MTA package. The patch enables "plugin" programs to be run at various
stages during an SMTP protocol exchange.
</p><p>
This package implements a qmail-spp-style plugin that performs certain checks
on the "user" part of evelope recipient addresses.
</p>

<h2>How it works</h2>

<p>
First, the plugin checks if the recipient address should be checked at all
by looking at the "RELAYCLIENT" environment variable and comparing the
<em>domain</em> part of the address to the domains listed in
"$LUCHECK_CONTROL/locals" (which should contain the full path to your "control"
directory). If not, it exits immediately.
</p><p>
If "$LUCHECK_CONTROL/virtualdomains" exists and <em>domain</em> is listed in it,
the plugin exits as well (assuming the local user for handling the virtual
domain is set up properly).
</p><p>
If the environment variable "LUCHECK_FFDB" is set, use its contents as the
pathname of a "fastforward" style database. If the database contains
<em>user</em>, accept the address and exit.
</p><p>
Repeat the following steps:
</p>
<ol>
<li>If <em>user</em> is a local system user, accept the address and exit.</li>
<li>If "$LUCHECK_ALIASDIR/.qmail-<em>user</em>" exists, accept the address and
    exit.</li>
<li>If <em>user</em> contains a dash ('-'), strip the rightmost '-' and
    everything after it and repeat the previous steps with the new
    <em>user</Em>.</li>
</ol>
<p>
If the address has not yet been accepted at this point, reject it with an
error message.
</p>

<h2>Status</h2>
<p>
The current implementation is pretty much ALPHA quality. Use at your own risk!
</p>

<h2>Downloading</h2>
<p>
This package should be available at 
<a href="http://www.unix-ag.uni-kl.de/~conrad/lucheck/">http://www.unix-ag.uni-kl.de/~conrad/lucheck/</a>
</p><p>
The sources are managed using the
<a hreF="http://www.gnuarch.org/#Gnu-arch">GNU Arch</a> revision control
system. You can check out a copy using
</p>
<pre>
tla register-archive conrad@tivano.de--2004 \
        http://www.unix-ag.uni-kl.de/~conrad/Archives/conrad@tivano.de--2004
tla grab http://www.unix-ag.uni-kl.de/~conrad/lucheck/releases--0.1
</pre>

<h2>Building</h2>
<p>
Simply unpack the sources and type "make" in the top-level directory of the
distribution. This will create a subdirectory ",,build", in which the build
will take place.
</p><p>
The resulting executable will reside in ",,build/src/lucheck-spp".
</p>

<h2>Installing</h2>
<p>
A "make install" target is *not* provided, because the installation process
requires some manual intervention as well as some decisions you'll have to
make yourself. Basically, you'll have to perform the steps enumerated below.
For RPM-based systems, a .spec file is provided (assuming a qmail installation
under /var/qmail). The RPM-based installation requires some manual work as
well.
</p><p>
Note: If you're upgrading your RPM-based installation with "rpm -U" you'll
have to manually edit "control/smtpplugins" afterwards. For some reason
rpm executes the "preun" script *after* the "post" script...
</p>
<ol>
<li>As has been said above, this program is a *plugin* for a Qmail installation
    that was built with the qmail-spp patch. So, as the first step, you'll
    have to build and install Qmail with that patch.
<br>
    In the following, we'll assume that the patched Qmail is installed in
    "/var/qmail" (the default location).
</li>

<li>If you don't have a directory where your plugins reside, create it. It must
    be situated somewhere within the Qmail installation dir.
<br>
    In the following, we'll assume that the plugin dir is "/var/qmail/plugins".
</li>

<li>After building this plugin with "make", copy the resulting executable
    to the plugin directory "/var/qmail/plugins".
</li>

<li>Modify whatever process you use for running qmail-smtpd to set the
    environment variables "LUCHECK_CONTROL", "LUCHECK_ALIASDIR" and optionally
    "LUCHECK_FFDB" to appropriate values.
<br>
    For example:
<pre>
     LUCHECK_CONTROL=/var/qmail/control/locals
     LUCHECK_ALIASDIR=/var/qmail/alias
     export LUCHECK_CONTROL LUCHECK_ALIASDIR
     tcpserver -R -v -x /etc/tcprules.smtpd.cdb -c 20 0 smtp qmail-smtpd 2>&1
</pre>
    Don't forget to restart the service if required!
</li>

<li>Enable the plugin by adding the path (relative to the qmail installation
    dir) to the "[rcpt]" section of the qmail-spp configuration file
    "/var/qmail/control/smtpplugins".
    Minimal example:
<pre>
[auth]

[helo]

[mail]

[rcpt]
plugins/lucheck-spp
</pre>
</li>

<li>Keep an eye on your log files. Remember, this is ALPHA software!
</li>
</ol>

</body></html>
<!--
arch-tag: 3ee3cffa-bb93-4bd3-8498-ea23be34b745
-->
